import os
import sys
from pathlib import Path
from sqlalchemy import text
from database.connection import engine, Base, SessionLocal, test_connection
from database.models import ProductMaster, Transaction, TransactionDetail

def create_all_tables():
    """å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ"""
    print("=" * 60)
    print("ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆé–‹å§‹")
    print("=" * 60)
    
    try:
        # ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
        Base.metadata.create_all(bind=engine)
        print("âœ… å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆã«æˆåŠŸã—ã¾ã—ãŸ")
        
        # ä½œæˆã•ã‚ŒãŸãƒ†ãƒ¼ãƒ–ãƒ«ã®ç¢ºèª
        with engine.connect() as connection:
            result = connection.execute(text("""
                SELECT TABLE_NAME 
                FROM INFORMATION_SCHEMA.TABLES 
                WHERE TABLE_SCHEMA = DATABASE()
                  AND TABLE_TYPE = 'BASE TABLE'
                ORDER BY TABLE_NAME
            """))
            tables = result.fetchall()
            
            print("\nğŸ“‹ ä½œæˆã•ã‚ŒãŸãƒ†ãƒ¼ãƒ–ãƒ«:")
            for table in tables:
                print(f"   - {table[0]}")
        
        return True
        
    except Exception as e:
        print(f"âŒ ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã‚¨ãƒ©ãƒ¼: {e}")
        import traceback
        traceback.print_exc()
        return False


def drop_all_tables():
    """å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤ï¼ˆæ³¨æ„: ãƒ‡ãƒ¼ã‚¿ã‚‚å…¨ã¦å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰"""
    print("=" * 60)
    print("âš ï¸  å…¨ãƒ†ãƒ¼ãƒ–ãƒ«å‰Šé™¤é–‹å§‹")
    print("=" * 60)
    
    response = input("æœ¬å½“ã«å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹? (yes/no): ")
    if response.lower() != 'yes':
        print("ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ")
        return False
    
    try:
        Base.metadata.drop_all(bind=engine)
        print("âœ… å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã®å‰Šé™¤ã«æˆåŠŸã—ã¾ã—ãŸ")
        return True
        
    except Exception as e:
        print(f"âŒ ãƒ†ãƒ¼ãƒ–ãƒ«å‰Šé™¤ã‚¨ãƒ©ãƒ¼: {e}")
        return False


def add_sample_data():
    """ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ """
    print("=" * 60)
    print("ğŸ“ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿è¿½åŠ é–‹å§‹")
    print("=" * 60)
    
    session = SessionLocal()
    
    try:
        # æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ï¼ˆå¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’è€ƒæ…®ã—ãŸé †åºï¼‰
        session.execute(text("DELETE FROM transaction_details"))
        session.execute(text("DELETE FROM transactions"))
        session.execute(text("DELETE FROM product_master"))
        session.commit()
        print("æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ")
        
        # å•†å“ãƒã‚¹ã‚¿ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
        sample_products = [
            ProductMaster(code='1234567890123', name='ãŠãƒ¼ã„ãŠèŒ¶', price=150),
            ProductMaster(code='2345678901234', name='ã‚½ãƒ•ãƒ©ãƒ³', price=300),
            ProductMaster(code='3456789012345', name='ç¦å³¶ç”£ã»ã†ã‚Œã‚“è‰', price=188),
            ProductMaster(code='4567890123456', name='ã‚¿ã‚¤ã‚¬ãƒ¼æ­¯ãƒ–ãƒ©ã‚·é’', price=200),
            ProductMaster(code='5678901234567', name='å››ãƒ„è°·ã‚µã‚¤ãƒ€ãƒ¼', price=160),
            ProductMaster(code='6789012345678', name='ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ãƒãƒ¼ãƒˆB5', price=180),
            ProductMaster(code='7890123456789', name='ä¸‰è±é‰›ç­†HB', price=120),
            ProductMaster(code='8901234567890', name='ãƒ›ãƒƒãƒã‚­ã‚¹ä¸­å‹', price=450),
            ProductMaster(code='9012345678901', name='ã‚¯ãƒªã‚¢ãƒ•ã‚¡ã‚¤ãƒ«20æš', price=280),
            ProductMaster(code='0123456789012', name='ãƒã‚¹ãƒˆã‚¤ãƒƒãƒˆ75mm', price=220),
        ]
        
        for product in sample_products:
            session.add(product)
        
        session.commit()
        print(f"âœ… {len(sample_products)}ä»¶ã®å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¾ã—ãŸ")
        
        # ãƒ‡ãƒ¼ã‚¿ç¢ºèª
        products = session.query(ProductMaster).all()
        print("\nğŸ“¦ ç™»éŒ²ã•ã‚ŒãŸå•†å“:")
        for product in products:
            print(f"   - {product}")
        
    except Exception as e:
        session.rollback()
        print(f"âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        import traceback
        traceback.print_exc()
        
    finally:
        session.close()


def verify_database():
    """ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ ã®æ¤œè¨¼"""
    print("=" * 60)
    print("ğŸ” ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¤œè¨¼é–‹å§‹")
    print("=" * 60)
    
    session = SessionLocal()
    
    try:
        # ãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèª
        with engine.connect() as connection:
            # ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§
            result = connection.execute(text("""
                SELECT 
                    TABLE_NAME,
                    TABLE_ROWS,
                    ENGINE,
                    TABLE_COLLATION
                FROM INFORMATION_SCHEMA.TABLES
                WHERE TABLE_SCHEMA = DATABASE()
                  AND TABLE_TYPE = 'BASE TABLE'
                ORDER BY TABLE_NAME
            """))
            
            print("\nğŸ“‹ ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±:")
            for row in result:
                print(f"   - {row[0]}: {row[1]}è¡Œ, Engine={row[2]}, Collation={row[3]}")
            
            # ã‚«ãƒ©ãƒ æƒ…å ±
            result = connection.execute(text("""
                SELECT 
                    TABLE_NAME,
                    COUNT(*) as ColumnCount
                FROM INFORMATION_SCHEMA.COLUMNS
                WHERE TABLE_SCHEMA = DATABASE()
                GROUP BY TABLE_NAME
                ORDER BY TABLE_NAME
            """))
            
            print("\nğŸ“ ã‚«ãƒ©ãƒ æ•°:")
            for row in result:
                print(f"   - {row[0]}: {row[1]}ã‚«ãƒ©ãƒ ")
            
            # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç¢ºèª
            result = connection.execute(text("""
                SELECT 
                    TABLE_NAME,
                    INDEX_NAME,
                    NON_UNIQUE,
                    INDEX_TYPE
                FROM INFORMATION_SCHEMA.STATISTICS
                WHERE TABLE_SCHEMA = DATABASE()
                ORDER BY TABLE_NAME, INDEX_NAME
            """))
            
            print("\nğŸ“‡ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æƒ…å ±:")
            for row in result:
                unique_str = "UNIQUE" if row[2] == 0 else "NON-UNIQUE"
                print(f"   - {row[0]}.{row[1]} ({unique_str}, {row[3]})")
            
            # å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ç¢ºèª
            result = connection.execute(text("""
                SELECT 
                    CONSTRAINT_NAME,
                    TABLE_NAME,
                    REFERENCED_TABLE_NAME
                FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE
                WHERE TABLE_SCHEMA = DATABASE()
                  AND REFERENCED_TABLE_NAME IS NOT NULL
                ORDER BY TABLE_NAME
            """))
            
            print("\nğŸ”— å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„:")
            for row in result:
                print(f"   - {row[0]}: {row[1]} -> {row[2]}")
        
        # ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ç¢ºèª
        product_count = session.query(ProductMaster).count()
        transaction_count = session.query(Transaction).count()
        detail_count = session.query(TransactionDetail).count()
        
        print("\nğŸ“Š ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°:")
        print(f"   - product_master: {product_count}ä»¶")
        print(f"   - transactions: {transaction_count}ä»¶")
        print(f"   - transaction_details: {detail_count}ä»¶")
        
        print("\nâœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¤œè¨¼å®Œäº†")
        
    except Exception as e:
        print(f"âŒ æ¤œè¨¼ã‚¨ãƒ©ãƒ¼: {e}")
        import traceback
        traceback.print_exc()
        
    finally:
        session.close()


def main():
    """ãƒ¡ã‚¤ãƒ³å‡¦ç†"""
    print("\nğŸš€ POSã‚·ã‚¹ãƒ†ãƒ  ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— (MySQLç‰ˆ)")
    print("=" * 60)
    
    # æ¥ç¶šãƒ†ã‚¹ãƒˆ
    if not test_connection():
        print("âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ")
        print("\næ¥ç¶šæƒ…å ±ã‚’ç¢ºèªã—ã¦ãã ã•ã„:")
        print(f"  - DB_HOST: {os.getenv('DB_HOST')}")
        print(f"  - DB_PORT: {os.getenv('DB_PORT')}")
        print(f"  - DB_NAME: {os.getenv('DB_NAME')}")
        print(f"  - DB_USER: {os.getenv('DB_USER')}")
        sys.exit(1)
    
    print("\nä»¥ä¸‹ã®æ“ä½œã‚’é¸æŠã—ã¦ãã ã•ã„:")
    print("1. ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ")
    print("2. ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿è¿½åŠ ")
    print("3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¤œè¨¼")
    print("4. å…¨å®Ÿè¡Œï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ â†’ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿è¿½åŠ  â†’ æ¤œè¨¼ï¼‰")
    print("9. å…¨ãƒ†ãƒ¼ãƒ–ãƒ«å‰Šé™¤ï¼ˆå±é™ºï¼‰")
    print("0. çµ‚äº†")
    
    choice = input("\né¸æŠã—ã¦ãã ã•ã„ (0-4, 9): ")
    
    if choice == '1':
        create_all_tables()
    elif choice == '2':
        add_sample_data()
    elif choice == '3':
        verify_database()
    elif choice == '4':
        if create_all_tables():
            add_sample_data()
            verify_database()
    elif choice == '9':
        drop_all_tables()
    elif choice == '0':
        print("çµ‚äº†ã—ã¾ã™")
    else:
        print("ç„¡åŠ¹ãªé¸æŠã§ã™")


if __name__ == "__main__":
    main()